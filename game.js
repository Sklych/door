import{isDebug as t,getUserState as e,updateUserState as i,UserState as s}from"./network.js";function animateBackground(t){let e=document.getElementById(t),i=e.getContext("2d");function s(){e.width=window.innerWidth,e.height=window.innerHeight}s(),window.addEventListener("resize",s);let r=Array.from({length:120}).map(()=>({x:Math.random()*e.width,y:Math.random()*e.height,radius:2*Math.random()+1,speed:1.5*Math.random()+.5}));!function t(){i.clearRect(0,0,e.width,e.height),i.fillStyle="white",r.forEach(t=>{i.beginPath(),i.arc(t.x,t.y,t.radius,0,2*Math.PI),i.fill(),t.y+=t.speed,t.y>e.height&&(t.y=0,t.x=Math.random()*e.width)}),requestAnimationFrame(t)}()}function showContent(t,e,s){let r=document.getElementById("play_nav_item"),a=document.getElementById("tasks_nav_item"),n=document.getElementById("leaders_nav_item"),h=document.getElementById("cash_out_nav_item");r.textContent=t.bottombar.playItem.title,a.textContent=t.bottombar.tasksItem.title,n.textContent=t.bottombar.leadersItem.title,h.textContent=t.bottombar.withdrawItem.title,document.getElementById("progress").style.display="none",document.getElementById("error-content").style.display="none",document.getElementById("main-content").style.display="block",animateBackground("content-background-stars"),x(0,t.balance.value,"usdt-text","",t.balance.precision),x(0,t.reward.coefficient,"coefficient-text"," X");let o=document.getElementById("coefficient-menu-item");t.reward.coefficient>=t.reward.maxCoefficient&&o.classList.add("gold");let d=document.getElementById("usdt-menu-item");o.addEventListener("click",()=>{document.getElementById("earn-nav-item").click()}),d.addEventListener("click",()=>{document.getElementById("withdraw-nav-item").click()});let p=Math.PI/180,c=document.getElementById("canvas"),l=c.getContext("2d");c.tabIndex=1,c.addEventListener("click",()=>{switch(m.curr){case m.getReady:m.curr=m.Play;break;case m.Play:u.flap();break;case m.gameOver:m.curr=m.getReady,u.speed=0,u.y=100,y.pipes=[],y.pipesMap.clear(),y.pipe_id=0,w.rewards=[],$.score.curr=0,$.score.coefficient=1,$.uploadState=!0}}),c.onkeydown=function t(e){if(32==e.keyCode||87==e.keyCode||38==e.keyCode)switch(m.curr){case m.getReady:m.curr=m.Play;break;case m.Play:u.flap();break;case m.gameOver:m.curr=m.getReady,u.speed=0,u.y=100,y.pipes=[],y.pipesMap.clear(),y.pipe_id=0,w.rewards=[],$.score.curr=0,$.score.coefficient=1,$.uploadState=!0}};let g=0,m={curr:0,getReady:0,Play:1,gameOver:2},f={sprite:new Image,x:0,y:0,draw:function(){this.y=c.height-this.sprite.height;let t=Math.ceil(c.width/this.sprite.width)+1;if(t!=1/0)for(let e=0;e<t;e++)l.drawImage(this.sprite,this.x+e*this.sprite.width,this.y)},update:function(){m.curr==m.Play&&(this.x-=2,this.x<=-this.sprite.width&&(this.x=0))}};new Image;let y={top:{sprite:new Image},bot:{sprite:new Image},gap:85,moved:!0,pipes:[],pipesMap:new Map,pipe_id:0,draw:function(){for(let t=0;t<this.pipes.length;t++){let e=this.pipes[t];l.drawImage(this.top.sprite,e.x,e.y),l.drawImage(this.bot.sprite,e.x,e.y+parseFloat(this.top.sprite.height)+this.gap)}},update:function(){if(m.curr==m.Play){if(g%100==0){let t=parseFloat(c.width);this.pipes.push({id:this.pipe_id++,x:t,y:-210*Math.min(Math.random()+1,1.8)})}this.pipes.forEach(t=>{t.x-=2}),this.pipes.length&&this.pipes[0].x<-this.top.sprite.width&&(this.pipes.shift(),this.moved=!0)}}},u={animations:[{sprite:new Image},{sprite:new Image},{sprite:new Image},{sprite:new Image},],rotatation:0,x:50,y:100,speed:0,gravity:.125,thrust:3.6,frame:0,draw:function(){let t=this.animations[this.frame].sprite.height,e=this.animations[this.frame].sprite.width;l.save(),l.translate(this.x,this.y),l.rotate(this.rotatation*p),l.drawImage(this.animations[this.frame].sprite,-e/2,-t/2),l.restore()},update:function(){let t=parseFloat(this.animations[0].sprite.width)/2;switch(m.curr){case m.getReady:this.rotatation=0,this.y+=g%10==0?Math.sin(g*p):0,this.frame+=g%10==0?1:0;break;case m.Play:this.frame+=g%5==0?1:0,this.y+=this.speed,this.setRotation(),this.speed+=this.gravity,(this.y+t>=f.y||this.collisioned())&&(m.curr=m.gameOver);break;case m.gameOver:this.frame=1,this.y+t<f.y?(this.y+=this.speed,this.setRotation(),this.speed+=2*this.gravity):(this.speed=0,this.y=f.y-t,this.rotatation=90)}this.frame=this.frame%this.animations.length},flap:function(){this.y>0&&(this.speed=-this.thrust)},setRotation:function(){this.speed<=0?this.rotatation=Math.max(-25,-25*this.speed/(-1*this.thrust)):this.speed>0&&(this.rotatation=Math.min(90,90*this.speed/(2*this.thrust)))},collisioned:function(){if(!y.pipes.length)return;let t=this.animations[0].sprite,e=y.pipes[0].x,i=y.pipes[0].y,s=t.height/4+t.width/4,r=i+parseFloat(y.top.sprite.height),a=r+y.gap,n=parseFloat(y.top.sprite.width);if(this.x+s>=e){if(this.x+s<e+n){if(this.y-s<=r||this.y+s>=a)return!0}else if(y.moved){if(y.pipes.length>0){let h=y.pipes[0].id+1;h>=12?$.score.coefficient=6:h>=9?$.score.coefficient=5:h>=6?$.score.coefficient=4:h>=3?$.score.coefficient=3:h>=2?$.score.coefficient=2:$.score.coefficient=1}$.score.curr=$.score.curr+1*$.score.coefficient,y.moved=!1}}}},$={getReady:{sprite:new Image},gameOver:{sprite:new Image},tap:[{sprite:new Image},{sprite:new Image}],score:{curr:0,best:0,coefficient:1},uploadState:!0,x:0,y:0,tx:0,ty:0,frame:0,draw:function(){switch(m.curr){case m.getReady:this.y=parseFloat(c.height-this.getReady.sprite.height)/2,this.x=parseFloat(c.width-this.getReady.sprite.width)/2,this.tx=parseFloat(c.width-this.tap[0].sprite.width)/2,this.ty=this.y+this.getReady.sprite.height-this.tap[0].sprite.height,l.drawImage(this.getReady.sprite,this.x,this.y),l.drawImage(this.tap[this.frame].sprite,this.tx,this.ty);break;case m.gameOver:this.y=parseFloat(c.height-this.gameOver.sprite.height)/2,this.x=parseFloat(c.width-this.gameOver.sprite.width)/2,this.tx=parseFloat(c.width-this.tap[0].sprite.width)/2,this.ty=this.y+this.gameOver.sprite.height-this.tap[0].sprite.height,l.drawImage(this.gameOver.sprite,this.x,this.y),l.drawImage(this.tap[this.frame].sprite,this.tx,this.ty),this.uploadState&&(this.uploadState=!1,this.score.curr>t.score.best&&(t.score.best=this.score.curr),function t(e,s,r){(async()=>{await i(e.uid,e.score.best,e.balance.value,r)||showError(s)})()}(t,e,s))}this.drawScore()},drawScore:function(){switch(l.fillStyle="#FFFFFF",l.strokeStyle="#000000",m.curr){case m.Play:l.lineWidth="2",l.font="35px Squada One",l.fillText(`${this.score.curr} (${this.score.coefficient} X)`,c.width/2-5,50),l.strokeText(this.score.curr,c.width/2-5,50);break;case m.gameOver:l.lineWidth="2",l.font="40px Squada One";let t=`SCORE :     ${this.score.curr}`;try{l.fillText(t,c.width/2-80,c.height/2+0),l.strokeText(t,c.width/2-80,c.height/2+0)}catch(e){l.fillText(t,c.width/2-85,c.height/2+15),l.strokeText(t,c.width/2-85,c.height/2+15)}}},update:function(){m.curr!=m.Play&&(this.frame+=g%10==0?1:0,this.frame=this.frame%this.tap.length)}},w={sprite:new Image,width:24,height:24,gapFromPipe:30,rewards:[],draw:function(){this.rewards.forEach(t=>{l.drawImage(this.sprite,t.x,t.y,w.width,w.height)})},update:function(){if(m.curr!=m.Play)return;this.rewards.forEach(t=>{t.x-=2}),this.rewards=this.rewards.filter(t=>t.x+this.width>0);let e=y.pipes[y.pipes.length-1];if(e&&!y.pipesMap.has(e.id)&&(y.pipesMap.set(e.id,0),y.pipesMap.size>0&&Math.floor(100*Math.random())+1<=t.reward.probability)){let i=e.y+y.top.sprite.height+y.gap/2-this.height/2;this.rewards.push({x:e.x+y.top.sprite.width/2-this.width/2,y:i,collected:!1})}},checkCollision:function(){this.rewards.forEach((e,i)=>{var s,r;let a,n,h,o,d,p,c,l,g;!e.collected&&(s=u,r=e,a=s.animations[0].sprite.width/2,n=s.x,h=s.y,o=r.x,d=r.x+w.width,p=r.y,c=r.y+w.height,l=n-Math.max(o,Math.min(n,d)),l*l+(g=h-Math.max(p,Math.min(h,c)))*g<a*a)&&(e.collected=!0,x(t.balance.value,t.balance.value+t.reward.coefficient*t.reward.usdtValue,"usdt-text","",t.balance.precision),t.balance.value+=t.reward.coefficient*t.reward.usdtValue,this.rewards.splice(i,1))})}};function x(t,e,i,s,r=1){let a=document.getElementById(i),n=performance.now();function h(i){let o=Math.min((i-n)/500,1);a.textContent=(t+(e-t)*o).toFixed(r)+s,o<1&&requestAnimationFrame(h)}requestAnimationFrame(h)}w.sprite.src="img/reward/usdt-svgrepo-com.svg",f.sprite.src="img/ground.png",y.top.sprite.src="img/toppipe.png",y.bot.sprite.src="img/botpipe.png",$.gameOver.sprite.src="img/go.png",$.getReady.sprite.src="img/getready.png",$.tap[0].sprite.src="img/tap/t0.png",$.tap[1].sprite.src="img/tap/t1.png",u.animations[0].sprite.src="img/bird/b0.png",u.animations[1].sprite.src="img/bird/b1.png",u.animations[2].sprite.src="img/bird/b2.png",u.animations[3].sprite.src="img/bird/b0.png";let b=l.createLinearGradient(0,0,0,canvas.height);b.addColorStop(0,"#6a0dad"),b.addColorStop(1,"#9b30ff"),setInterval(function t(){u.update(),f.update(),y.update(),w.update(),w.checkCollision(),$.update(),l.fillStyle=b,l.fillRect(0,0,c.width,c.height),y.draw(),w.draw(),u.draw(),f.draw(),$.draw(),g++},17)}function showLoading(){document.getElementById("progress").style.display="block"}function showError(t){document.getElementById("progress").style.display="none",document.getElementById("main-content").style.display="none",document.getElementById("error-content").style.display="flex","ru"==t?(document.getElementById("error-message").textContent="Произошла ошибка",document.getElementById("reload-button").textContent="Перезагрузить"):(document.getElementById("error-message").textContent="An error occurred",document.getElementById("reload-button").textContent="Reload"),animateBackground("error-background-stars")}let tg=null;t||(tg=window.Telegram.WebApp).ready(),window.onerror=function(t,e,i,s,r){window.location.reload()},window.onload=function(){showLoading(),(async()=>{try{if(t){let i=await e("1","en",null,null,"gamePage",null);i?showContent(i,"en",null):showError("en")}else{let s=tg.initDataUnsafe.user,r=s.language_code,a=tg.initDataUnsafe.start_param,n=`username=${tg.initDataUnsafe.user.username}, first_name=${tg.initDataUnsafe.user.first_name}, last_name=${tg.initDataUnsafe.user.last_name}`,h=tg.initData;console.log(tg.initDataUnsafe),console.log("READ user ",s),console.log("READ ref ",a),console.log("READ language code ",r);let o=await e(s.id,r??"en",a,n,"gamePage",h);o?showContent(o,r,h):showError(r)}}catch(d){t?console.error(`${d}`):console.error(`${d}, ${tg.initData}, ${tg.initDataUnsafe}, ${tg},`),showError("en")}})(),document.querySelectorAll(".nav-item").forEach(t=>{t.addEventListener("click",()=>{let e=t.getAttribute("data-url");e&&"index.html"!=e&&(window.location.href=e)})})};