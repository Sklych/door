import{isDebug as t,getUserState as e,updateUserState as i,UserState as s}from"./network.js";function animateBackground(t){let e=document.getElementById(t),i=e.getContext("2d");function s(){e.width=window.innerWidth,e.height=window.innerHeight}s(),window.addEventListener("resize",s);let r=Array.from({length:120}).map(()=>({x:Math.random()*e.width,y:Math.random()*e.height,radius:2*Math.random()+1,speed:1.5*Math.random()+.5}));!function t(){i.clearRect(0,0,e.width,e.height),i.fillStyle="white",r.forEach(t=>{i.beginPath(),i.arc(t.x,t.y,t.radius,0,2*Math.PI),i.fill(),t.y+=t.speed,t.y>e.height&&(t.y=0,t.x=Math.random()*e.width)}),requestAnimationFrame(t)}()}function showContent(t){let e=document.getElementById("play_nav_item"),s=document.getElementById("tasks_nav_item"),r=document.getElementById("cash_out_nav_item");e.textContent=t.bottombar.playItem.title,s.textContent=t.bottombar.tasksItem.title,r.textContent=t.bottombar.withdrawItem.title,document.getElementById("progress").style.display="none",document.getElementById("error-content").style.display="none",document.getElementById("main-content").style.display="block",animateBackground("content-background-stars"),$(0,t.balance.value,"usdt-text","",t.balance.precision),$(0,t.reward.coefficient,"coefficient-text"," X");let a=document.getElementById("coefficient-menu-item"),n=document.getElementById("usdt-menu-item");a.addEventListener("click",()=>{document.getElementById("earn-nav-item").click()}),n.addEventListener("click",()=>{document.getElementById("withdraw-nav-item").click()});let h=Math.PI/180,o=document.getElementById("canvas"),d=o.getContext("2d");o.tabIndex=1,o.addEventListener("click",()=>{switch(c.curr){case c.getReady:c.curr=c.Play;break;case c.Play:m.flap();break;case c.gameOver:c.curr=c.getReady,m.speed=0,m.y=100,g.pipes=[],g.pipesMap.clear(),g.pipe_id=0,y.rewards=[],f.score.curr=0,f.score.coefficient=1,f.uploadState=!0}}),o.onkeydown=function t(e){if(32==e.keyCode||87==e.keyCode||38==e.keyCode)switch(c.curr){case c.getReady:c.curr=c.Play;break;case c.Play:m.flap();break;case c.gameOver:c.curr=c.getReady,m.speed=0,m.y=100,g.pipes=[],g.pipesMap.clear(),g.pipe_id=0,y.rewards=[],f.score.curr=0,f.score.coefficient=1,f.uploadState=!0}};let p=0,c={curr:0,getReady:0,Play:1,gameOver:2},l={sprite:new Image,x:0,y:0,draw:function(){this.y=o.height-this.sprite.height;let t=Math.ceil(o.width/this.sprite.width)+1;if(t!=1/0)for(let e=0;e<t;e++)d.drawImage(this.sprite,this.x+e*this.sprite.width,this.y)},update:function(){c.curr==c.Play&&(this.x-=2,this.x<=-this.sprite.width&&(this.x=0))}};new Image;let g={top:{sprite:new Image},bot:{sprite:new Image},gap:85,moved:!0,pipes:[],pipesMap:new Map,pipe_id:0,draw:function(){for(let t=0;t<this.pipes.length;t++){let e=this.pipes[t];d.drawImage(this.top.sprite,e.x,e.y),d.drawImage(this.bot.sprite,e.x,e.y+parseFloat(this.top.sprite.height)+this.gap)}},update:function(){if(c.curr==c.Play){if(p%100==0){let t=parseFloat(o.width);this.pipes.push({id:this.pipe_id++,x:t,y:-210*Math.min(Math.random()+1,1.8)})}this.pipes.forEach(t=>{t.x-=2}),this.pipes.length&&this.pipes[0].x<-this.top.sprite.width&&(this.pipes.shift(),this.moved=!0)}}},m={animations:[{sprite:new Image},{sprite:new Image},{sprite:new Image},{sprite:new Image},],rotatation:0,x:50,y:100,speed:0,gravity:.125,thrust:3.6,frame:0,draw:function(){let t=this.animations[this.frame].sprite.height,e=this.animations[this.frame].sprite.width;d.save(),d.translate(this.x,this.y),d.rotate(this.rotatation*h),d.drawImage(this.animations[this.frame].sprite,-e/2,-t/2),d.restore()},update:function(){let t=parseFloat(this.animations[0].sprite.width)/2;switch(c.curr){case c.getReady:this.rotatation=0,this.y+=p%10==0?Math.sin(p*h):0,this.frame+=p%10==0?1:0;break;case c.Play:this.frame+=p%5==0?1:0,this.y+=this.speed,this.setRotation(),this.speed+=this.gravity,(this.y+t>=l.y||this.collisioned())&&(c.curr=c.gameOver);break;case c.gameOver:this.frame=1,this.y+t<l.y?(this.y+=this.speed,this.setRotation(),this.speed+=2*this.gravity):(this.speed=0,this.y=l.y-t,this.rotatation=90)}this.frame=this.frame%this.animations.length},flap:function(){this.y>0&&(this.speed=-this.thrust)},setRotation:function(){this.speed<=0?this.rotatation=Math.max(-25,-25*this.speed/(-1*this.thrust)):this.speed>0&&(this.rotatation=Math.min(90,90*this.speed/(2*this.thrust)))},collisioned:function(){if(!g.pipes.length)return;let t=this.animations[0].sprite,e=g.pipes[0].x,i=g.pipes[0].y,s=t.height/4+t.width/4,r=i+parseFloat(g.top.sprite.height),a=r+g.gap,n=parseFloat(g.top.sprite.width);if(this.x+s>=e){if(this.x+s<e+n){if(this.y-s<=r||this.y+s>=a)return!0}else if(g.moved){if(g.pipes.length>0){let h=g.pipes[0].id+1;h>=12?f.score.coefficient=6:h>=9?f.score.coefficient=5:h>=6?f.score.coefficient=4:h>=3?f.score.coefficient=3:h>=2?f.score.coefficient=2:f.score.coefficient=1}f.score.curr=f.score.curr+1*f.score.coefficient,g.moved=!1}}}},f={getReady:{sprite:new Image},gameOver:{sprite:new Image},tap:[{sprite:new Image},{sprite:new Image}],score:{curr:0,best:0,coefficient:1},uploadState:!0,x:0,y:0,tx:0,ty:0,frame:0,draw:function(){switch(c.curr){case c.getReady:this.y=parseFloat(o.height-this.getReady.sprite.height)/2,this.x=parseFloat(o.width-this.getReady.sprite.width)/2,this.tx=parseFloat(o.width-this.tap[0].sprite.width)/2,this.ty=this.y+this.getReady.sprite.height-this.tap[0].sprite.height,d.drawImage(this.getReady.sprite,this.x,this.y),d.drawImage(this.tap[this.frame].sprite,this.tx,this.ty);break;case c.gameOver:this.y=parseFloat(o.height-this.gameOver.sprite.height)/2,this.x=parseFloat(o.width-this.gameOver.sprite.width)/2,this.tx=parseFloat(o.width-this.tap[0].sprite.width)/2,this.ty=this.y+this.gameOver.sprite.height-this.tap[0].sprite.height,d.drawImage(this.gameOver.sprite,this.x,this.y),d.drawImage(this.tap[this.frame].sprite,this.tx,this.ty),this.uploadState&&(this.uploadState=!1,this.score.curr>t.score.best&&(t.score.best=this.score.curr),function t(e){(async()=>{await i(e.uid,e.score.best,e.balance.value)})()}(t))}this.drawScore()},drawScore:function(){switch(d.fillStyle="#FFFFFF",d.strokeStyle="#000000",c.curr){case c.Play:d.lineWidth="2",d.font="35px Squada One",d.fillText(`${this.score.curr} (${this.score.coefficient} X)`,o.width/2-5,50),d.strokeText(this.score.curr,o.width/2-5,50);break;case c.gameOver:d.lineWidth="2",d.font="40px Squada One";let t=`SCORE :     ${this.score.curr}`;try{d.fillText(t,o.width/2-80,o.height/2+0),d.strokeText(t,o.width/2-80,o.height/2+0)}catch(e){d.fillText(t,o.width/2-85,o.height/2+15),d.strokeText(t,o.width/2-85,o.height/2+15)}}},update:function(){c.curr!=c.Play&&(this.frame+=p%10==0?1:0,this.frame=this.frame%this.tap.length)}},y={sprite:new Image,width:24,height:24,gapFromPipe:30,rewards:[],draw:function(){this.rewards.forEach(t=>{d.drawImage(this.sprite,t.x,t.y,y.width,y.height)})},update:function(){if(c.curr!=c.Play)return;this.rewards.forEach(t=>{t.x-=2}),this.rewards=this.rewards.filter(t=>t.x+this.width>0);let e=g.pipes[g.pipes.length-1];if(e&&!g.pipesMap.has(e.id)&&(g.pipesMap.set(e.id,0),g.pipesMap.size>0&&Math.floor(100*Math.random())+1<=t.reward.probability)){let i=e.y+g.top.sprite.height+g.gap/2-this.height/2;this.rewards.push({x:e.x+g.top.sprite.width/2-this.width/2,y:i,collected:!1})}},checkCollision:function(){this.rewards.forEach((e,i)=>{var s,r;let a,n,h,o,d,p,c,l,g;!e.collected&&(s=m,r=e,a=s.animations[0].sprite.width/2,n=s.x,h=s.y,o=r.x,d=r.x+y.width,p=r.y,c=r.y+y.height,l=n-Math.max(o,Math.min(n,d)),l*l+(g=h-Math.max(p,Math.min(h,c)))*g<a*a)&&(e.collected=!0,$(t.balance.value,t.balance.value+t.reward.coefficient*t.reward.usdtValue,"usdt-text","",t.balance.precision),t.balance.value+=t.reward.coefficient*t.reward.usdtValue,this.rewards.splice(i,1))})}};function $(t,e,i,s,r=1){let a=document.getElementById(i),n=performance.now();function h(i){let o=Math.min((i-n)/500,1);a.textContent=(t+(e-t)*o).toFixed(r)+s,o<1&&requestAnimationFrame(h)}requestAnimationFrame(h)}y.sprite.src="img/reward/usdt-svgrepo-com.svg",l.sprite.src="img/ground.png",g.top.sprite.src="img/toppipe.png",g.bot.sprite.src="img/botpipe.png",f.gameOver.sprite.src="img/go.png",f.getReady.sprite.src="img/getready.png",f.tap[0].sprite.src="img/tap/t0.png",f.tap[1].sprite.src="img/tap/t1.png",m.animations[0].sprite.src="img/bird/b0.png",m.animations[1].sprite.src="img/bird/b1.png",m.animations[2].sprite.src="img/bird/b2.png",m.animations[3].sprite.src="img/bird/b0.png";let u=d.createLinearGradient(0,0,0,canvas.height);u.addColorStop(0,"#6a0dad"),u.addColorStop(1,"#9b30ff"),setInterval(function t(){m.update(),l.update(),g.update(),y.update(),y.checkCollision(),f.update(),d.fillStyle=u,d.fillRect(0,0,o.width,o.height),g.draw(),y.draw(),m.draw(),l.draw(),f.draw(),p++},17)}function showLoading(){document.getElementById("progress").style.display="block"}function showError(){document.getElementById("progress").style.display="none",document.getElementById("main-content").style.display="none",document.getElementById("error-content").style.display="flex",animateBackground("error-background-stars")}let tg=null;t||(tg=window.Telegram.WebApp).ready(),window.onerror=function(t,e,i,s,r){window.location.reload()},window.onload=function(){showLoading(),(async()=>{try{if(t){let i=await e("1","en",null,null);i?showContent(i):showError()}else{let s=tg.initDataUnsafe.user,r=s.language_code,a=tg.initDataUnsafe.start_param,n=`username=${tg.initDataUnsafe.user.username}, first_name=${tg.initDataUnsafe.user.first_name}, last_name=${tg.initDataUnsafe.user.last_name}`;console.log(tg.initDataUnsafe),console.log("READ user ",s),console.log("READ ref ",a),console.log("READ language code ",r);let h=await e(s.id,r??"en",a,n);h?showContent(h):showError()}}catch(o){t?console.error(`${o}`):console.error(`${o}, ${tg.initData}, ${tg.initDataUnsafe}, ${tg},`),showError(o)}})(),document.querySelectorAll(".nav-item").forEach(t=>{t.addEventListener("click",()=>{let e=t.getAttribute("data-url");e&&"index.html"!=e&&(window.location.href=e)})})};