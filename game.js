import{isDebug as t,getUserState as e,updateUserState as i,UserState as s}from"./network.js";function animateBackground(t){let e=document.getElementById(t),i=e.getContext("2d");function s(){e.width=window.innerWidth,e.height=window.innerHeight}s(),window.addEventListener("resize",s);let r=Array.from({length:120}).map(()=>({x:Math.random()*e.width,y:Math.random()*e.height,radius:2*Math.random()+1,speed:1.5*Math.random()+.5}));!function t(){i.clearRect(0,0,e.width,e.height),i.fillStyle="white",r.forEach(t=>{i.beginPath(),i.arc(t.x,t.y,t.radius,0,2*Math.PI),i.fill(),t.y+=t.speed,t.y>e.height&&(t.y=0,t.x=Math.random()*e.width)}),requestAnimationFrame(t)}()}function showContent(t){let e=document.getElementById("play_nav_item"),s=document.getElementById("tasks_nav_item"),r=document.getElementById("leaders_nav_item"),a=document.getElementById("cash_out_nav_item");e.textContent=t.bottombar.playItem.title,s.textContent=t.bottombar.tasksItem.title,r.textContent=t.bottombar.leadersItem.title,a.textContent=t.bottombar.withdrawItem.title,document.getElementById("progress").style.display="none",document.getElementById("error-content").style.display="none",document.getElementById("main-content").style.display="block",animateBackground("content-background-stars"),$(0,t.balance.value,"usdt-text","",t.balance.precision),$(0,t.reward.coefficient,"coefficient-text"," X");let n=document.getElementById("coefficient-menu-item");t.reward.coefficient==t.reward.maxCoefficient&&n.classList.add("gold");let h=document.getElementById("usdt-menu-item");n.addEventListener("click",()=>{document.getElementById("earn-nav-item").click()}),h.addEventListener("click",()=>{document.getElementById("withdraw-nav-item").click()});let o=Math.PI/180,d=document.getElementById("canvas"),p=d.getContext("2d");d.tabIndex=1,d.addEventListener("click",()=>{switch(l.curr){case l.getReady:l.curr=l.Play;break;case l.Play:f.flap();break;case l.gameOver:l.curr=l.getReady,f.speed=0,f.y=100,m.pipes=[],m.pipesMap.clear(),m.pipe_id=0,u.rewards=[],y.score.curr=0,y.score.coefficient=1,y.uploadState=!0}}),d.onkeydown=function t(e){if(32==e.keyCode||87==e.keyCode||38==e.keyCode)switch(l.curr){case l.getReady:l.curr=l.Play;break;case l.Play:f.flap();break;case l.gameOver:l.curr=l.getReady,f.speed=0,f.y=100,m.pipes=[],m.pipesMap.clear(),m.pipe_id=0,u.rewards=[],y.score.curr=0,y.score.coefficient=1,y.uploadState=!0}};let c=0,l={curr:0,getReady:0,Play:1,gameOver:2},g={sprite:new Image,x:0,y:0,draw:function(){this.y=d.height-this.sprite.height;let t=Math.ceil(d.width/this.sprite.width)+1;if(t!=1/0)for(let e=0;e<t;e++)p.drawImage(this.sprite,this.x+e*this.sprite.width,this.y)},update:function(){l.curr==l.Play&&(this.x-=2,this.x<=-this.sprite.width&&(this.x=0))}};new Image;let m={top:{sprite:new Image},bot:{sprite:new Image},gap:85,moved:!0,pipes:[],pipesMap:new Map,pipe_id:0,draw:function(){for(let t=0;t<this.pipes.length;t++){let e=this.pipes[t];p.drawImage(this.top.sprite,e.x,e.y),p.drawImage(this.bot.sprite,e.x,e.y+parseFloat(this.top.sprite.height)+this.gap)}},update:function(){if(l.curr==l.Play){if(c%100==0){let t=parseFloat(d.width);this.pipes.push({id:this.pipe_id++,x:t,y:-210*Math.min(Math.random()+1,1.8)})}this.pipes.forEach(t=>{t.x-=2}),this.pipes.length&&this.pipes[0].x<-this.top.sprite.width&&(this.pipes.shift(),this.moved=!0)}}},f={animations:[{sprite:new Image},{sprite:new Image},{sprite:new Image},{sprite:new Image},],rotatation:0,x:50,y:100,speed:0,gravity:.125,thrust:3.6,frame:0,draw:function(){let t=this.animations[this.frame].sprite.height,e=this.animations[this.frame].sprite.width;p.save(),p.translate(this.x,this.y),p.rotate(this.rotatation*o),p.drawImage(this.animations[this.frame].sprite,-e/2,-t/2),p.restore()},update:function(){let t=parseFloat(this.animations[0].sprite.width)/2;switch(l.curr){case l.getReady:this.rotatation=0,this.y+=c%10==0?Math.sin(c*o):0,this.frame+=c%10==0?1:0;break;case l.Play:this.frame+=c%5==0?1:0,this.y+=this.speed,this.setRotation(),this.speed+=this.gravity,(this.y+t>=g.y||this.collisioned())&&(l.curr=l.gameOver);break;case l.gameOver:this.frame=1,this.y+t<g.y?(this.y+=this.speed,this.setRotation(),this.speed+=2*this.gravity):(this.speed=0,this.y=g.y-t,this.rotatation=90)}this.frame=this.frame%this.animations.length},flap:function(){this.y>0&&(this.speed=-this.thrust)},setRotation:function(){this.speed<=0?this.rotatation=Math.max(-25,-25*this.speed/(-1*this.thrust)):this.speed>0&&(this.rotatation=Math.min(90,90*this.speed/(2*this.thrust)))},collisioned:function(){if(!m.pipes.length)return;let t=this.animations[0].sprite,e=m.pipes[0].x,i=m.pipes[0].y,s=t.height/4+t.width/4,r=i+parseFloat(m.top.sprite.height),a=r+m.gap,n=parseFloat(m.top.sprite.width);if(this.x+s>=e){if(this.x+s<e+n){if(this.y-s<=r||this.y+s>=a)return!0}else if(m.moved){if(m.pipes.length>0){let h=m.pipes[0].id+1;h>=12?y.score.coefficient=6:h>=9?y.score.coefficient=5:h>=6?y.score.coefficient=4:h>=3?y.score.coefficient=3:h>=2?y.score.coefficient=2:y.score.coefficient=1}y.score.curr=y.score.curr+1*y.score.coefficient,m.moved=!1}}}},y={getReady:{sprite:new Image},gameOver:{sprite:new Image},tap:[{sprite:new Image},{sprite:new Image}],score:{curr:0,best:0,coefficient:1},uploadState:!0,x:0,y:0,tx:0,ty:0,frame:0,draw:function(){switch(l.curr){case l.getReady:this.y=parseFloat(d.height-this.getReady.sprite.height)/2,this.x=parseFloat(d.width-this.getReady.sprite.width)/2,this.tx=parseFloat(d.width-this.tap[0].sprite.width)/2,this.ty=this.y+this.getReady.sprite.height-this.tap[0].sprite.height,p.drawImage(this.getReady.sprite,this.x,this.y),p.drawImage(this.tap[this.frame].sprite,this.tx,this.ty);break;case l.gameOver:this.y=parseFloat(d.height-this.gameOver.sprite.height)/2,this.x=parseFloat(d.width-this.gameOver.sprite.width)/2,this.tx=parseFloat(d.width-this.tap[0].sprite.width)/2,this.ty=this.y+this.gameOver.sprite.height-this.tap[0].sprite.height,p.drawImage(this.gameOver.sprite,this.x,this.y),p.drawImage(this.tap[this.frame].sprite,this.tx,this.ty),this.uploadState&&(this.uploadState=!1,this.score.curr>t.score.best&&(t.score.best=this.score.curr),function t(e){(async()=>{await i(e.uid,e.score.best,e.balance.value)})()}(t))}this.drawScore()},drawScore:function(){switch(p.fillStyle="#FFFFFF",p.strokeStyle="#000000",l.curr){case l.Play:p.lineWidth="2",p.font="35px Squada One",p.fillText(`${this.score.curr} (${this.score.coefficient} X)`,d.width/2-5,50),p.strokeText(this.score.curr,d.width/2-5,50);break;case l.gameOver:p.lineWidth="2",p.font="40px Squada One";let t=`SCORE :     ${this.score.curr}`;try{p.fillText(t,d.width/2-80,d.height/2+0),p.strokeText(t,d.width/2-80,d.height/2+0)}catch(e){p.fillText(t,d.width/2-85,d.height/2+15),p.strokeText(t,d.width/2-85,d.height/2+15)}}},update:function(){l.curr!=l.Play&&(this.frame+=c%10==0?1:0,this.frame=this.frame%this.tap.length)}},u={sprite:new Image,width:24,height:24,gapFromPipe:30,rewards:[],draw:function(){this.rewards.forEach(t=>{p.drawImage(this.sprite,t.x,t.y,u.width,u.height)})},update:function(){if(l.curr!=l.Play)return;this.rewards.forEach(t=>{t.x-=2}),this.rewards=this.rewards.filter(t=>t.x+this.width>0);let e=m.pipes[m.pipes.length-1];if(e&&!m.pipesMap.has(e.id)&&(m.pipesMap.set(e.id,0),m.pipesMap.size>0&&Math.floor(100*Math.random())+1<=t.reward.probability)){let i=e.y+m.top.sprite.height+m.gap/2-this.height/2;this.rewards.push({x:e.x+m.top.sprite.width/2-this.width/2,y:i,collected:!1})}},checkCollision:function(){this.rewards.forEach((e,i)=>{var s,r;let a,n,h,o,d,p,c,l,g;!e.collected&&(s=f,r=e,a=s.animations[0].sprite.width/2,n=s.x,h=s.y,o=r.x,d=r.x+u.width,p=r.y,c=r.y+u.height,l=n-Math.max(o,Math.min(n,d)),l*l+(g=h-Math.max(p,Math.min(h,c)))*g<a*a)&&(e.collected=!0,$(t.balance.value,t.balance.value+t.reward.coefficient*t.reward.usdtValue,"usdt-text","",t.balance.precision),t.balance.value+=t.reward.coefficient*t.reward.usdtValue,this.rewards.splice(i,1))})}};function $(t,e,i,s,r=1){let a=document.getElementById(i),n=performance.now();function h(i){let o=Math.min((i-n)/500,1);a.textContent=(t+(e-t)*o).toFixed(r)+s,o<1&&requestAnimationFrame(h)}requestAnimationFrame(h)}u.sprite.src="img/reward/usdt-svgrepo-com.svg",g.sprite.src="img/ground.png",m.top.sprite.src="img/toppipe.png",m.bot.sprite.src="img/botpipe.png",y.gameOver.sprite.src="img/go.png",y.getReady.sprite.src="img/getready.png",y.tap[0].sprite.src="img/tap/t0.png",y.tap[1].sprite.src="img/tap/t1.png",f.animations[0].sprite.src="img/bird/b0.png",f.animations[1].sprite.src="img/bird/b1.png",f.animations[2].sprite.src="img/bird/b2.png",f.animations[3].sprite.src="img/bird/b0.png";let w=p.createLinearGradient(0,0,0,canvas.height);w.addColorStop(0,"#6a0dad"),w.addColorStop(1,"#9b30ff"),setInterval(function t(){f.update(),g.update(),m.update(),u.update(),u.checkCollision(),y.update(),p.fillStyle=w,p.fillRect(0,0,d.width,d.height),m.draw(),u.draw(),f.draw(),g.draw(),y.draw(),c++},17)}function showLoading(){document.getElementById("progress").style.display="block"}function showError(t){document.getElementById("progress").style.display="none",document.getElementById("main-content").style.display="none",document.getElementById("error-content").style.display="flex","ru"==t?(document.getElementById("error-message").textContent="Произошла ошибка",document.getElementById("reload-button").textContent="Перезагрузить"):(document.getElementById("error-message").textContent="An error occurred",document.getElementById("reload-button").textContent="Reload"),animateBackground("error-background-stars")}let tg=null;t||(tg=window.Telegram.WebApp).ready(),window.onerror=function(t,e,i,s,r){window.location.reload()},window.onload=function(){showLoading(),(async()=>{try{if(t){let i=await e("1","en",null,null,"gamePage");i?showContent(i):showError("en")}else{let s=tg.initDataUnsafe.user,r=s.language_code,a=tg.initDataUnsafe.start_param,n=`username=${tg.initDataUnsafe.user.username}, first_name=${tg.initDataUnsafe.user.first_name}, last_name=${tg.initDataUnsafe.user.last_name}`;console.log(tg.initDataUnsafe),console.log("READ user ",s),console.log("READ ref ",a),console.log("READ language code ",r);let h=await e(s.id,r??"en",a,n,"gamePage");h?showContent(h):showError(r)}}catch(o){t?console.error(`${o}`):console.error(`${o}, ${tg.initData}, ${tg.initDataUnsafe}, ${tg},`),showError("en")}})(),document.querySelectorAll(".nav-item").forEach(t=>{t.addEventListener("click",()=>{let e=t.getAttribute("data-url");e&&"index.html"!=e&&(window.location.href=e)})})};