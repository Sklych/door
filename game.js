import{isDebug as t,getUserState as e,updateUserState as i,UserState as s}from"./network.js";function animateBackground(t){let e=document.getElementById(t),i=e.getContext("2d");function s(){e.width=window.innerWidth,e.height=window.innerHeight}s(),window.addEventListener("resize",s);let r=Array.from({length:120}).map(()=>({x:Math.random()*e.width,y:Math.random()*e.height,radius:2*Math.random()+1,speed:1.5*Math.random()+.5}));!function t(){i.clearRect(0,0,e.width,e.height),i.fillStyle="white",r.forEach(t=>{i.beginPath(),i.arc(t.x,t.y,t.radius,0,2*Math.PI),i.fill(),t.y+=t.speed,t.y>e.height&&(t.y=0,t.x=Math.random()*e.width)}),requestAnimationFrame(t)}()}function showContent(t,e){let s=document.getElementById("play_nav_item"),r=document.getElementById("tasks_nav_item"),a=document.getElementById("leaders_nav_item"),n=document.getElementById("cash_out_nav_item");s.textContent=t.bottombar.playItem.title,r.textContent=t.bottombar.tasksItem.title,a.textContent=t.bottombar.leadersItem.title,n.textContent=t.bottombar.withdrawItem.title,document.getElementById("progress").style.display="none",document.getElementById("error-content").style.display="none",document.getElementById("main-content").style.display="block",animateBackground("content-background-stars"),w(0,t.balance.value,"usdt-text","",t.balance.precision),w(0,t.reward.coefficient,"coefficient-text"," X");let h=document.getElementById("coefficient-menu-item");t.reward.coefficient==t.reward.maxCoefficient&&h.classList.add("gold");let o=document.getElementById("usdt-menu-item");h.addEventListener("click",()=>{document.getElementById("earn-nav-item").click()}),o.addEventListener("click",()=>{document.getElementById("withdraw-nav-item").click()});let d=Math.PI/180,p=document.getElementById("canvas"),c=p.getContext("2d");p.tabIndex=1,p.addEventListener("click",()=>{switch(g.curr){case g.getReady:g.curr=g.Play;break;case g.Play:y.flap();break;case g.gameOver:g.curr=g.getReady,y.speed=0,y.y=100,f.pipes=[],f.pipesMap.clear(),f.pipe_id=0,$.rewards=[],u.score.curr=0,u.score.coefficient=1,u.uploadState=!0}}),p.onkeydown=function t(e){if(32==e.keyCode||87==e.keyCode||38==e.keyCode)switch(g.curr){case g.getReady:g.curr=g.Play;break;case g.Play:y.flap();break;case g.gameOver:g.curr=g.getReady,y.speed=0,y.y=100,f.pipes=[],f.pipesMap.clear(),f.pipe_id=0,$.rewards=[],u.score.curr=0,u.score.coefficient=1,u.uploadState=!0}};let l=0,g={curr:0,getReady:0,Play:1,gameOver:2},m={sprite:new Image,x:0,y:0,draw:function(){this.y=p.height-this.sprite.height;let t=Math.ceil(p.width/this.sprite.width)+1;if(t!=1/0)for(let e=0;e<t;e++)c.drawImage(this.sprite,this.x+e*this.sprite.width,this.y)},update:function(){g.curr==g.Play&&(this.x-=2,this.x<=-this.sprite.width&&(this.x=0))}};new Image;let f={top:{sprite:new Image},bot:{sprite:new Image},gap:85,moved:!0,pipes:[],pipesMap:new Map,pipe_id:0,draw:function(){for(let t=0;t<this.pipes.length;t++){let e=this.pipes[t];c.drawImage(this.top.sprite,e.x,e.y),c.drawImage(this.bot.sprite,e.x,e.y+parseFloat(this.top.sprite.height)+this.gap)}},update:function(){if(g.curr==g.Play){if(l%100==0){let t=parseFloat(p.width);this.pipes.push({id:this.pipe_id++,x:t,y:-210*Math.min(Math.random()+1,1.8)})}this.pipes.forEach(t=>{t.x-=2}),this.pipes.length&&this.pipes[0].x<-this.top.sprite.width&&(this.pipes.shift(),this.moved=!0)}}},y={animations:[{sprite:new Image},{sprite:new Image},{sprite:new Image},{sprite:new Image},],rotatation:0,x:50,y:100,speed:0,gravity:.125,thrust:3.6,frame:0,draw:function(){let t=this.animations[this.frame].sprite.height,e=this.animations[this.frame].sprite.width;c.save(),c.translate(this.x,this.y),c.rotate(this.rotatation*d),c.drawImage(this.animations[this.frame].sprite,-e/2,-t/2),c.restore()},update:function(){let t=parseFloat(this.animations[0].sprite.width)/2;switch(g.curr){case g.getReady:this.rotatation=0,this.y+=l%10==0?Math.sin(l*d):0,this.frame+=l%10==0?1:0;break;case g.Play:this.frame+=l%5==0?1:0,this.y+=this.speed,this.setRotation(),this.speed+=this.gravity,(this.y+t>=m.y||this.collisioned())&&(g.curr=g.gameOver);break;case g.gameOver:this.frame=1,this.y+t<m.y?(this.y+=this.speed,this.setRotation(),this.speed+=2*this.gravity):(this.speed=0,this.y=m.y-t,this.rotatation=90)}this.frame=this.frame%this.animations.length},flap:function(){this.y>0&&(this.speed=-this.thrust)},setRotation:function(){this.speed<=0?this.rotatation=Math.max(-25,-25*this.speed/(-1*this.thrust)):this.speed>0&&(this.rotatation=Math.min(90,90*this.speed/(2*this.thrust)))},collisioned:function(){if(!f.pipes.length)return;let t=this.animations[0].sprite,e=f.pipes[0].x,i=f.pipes[0].y,s=t.height/4+t.width/4,r=i+parseFloat(f.top.sprite.height),a=r+f.gap,n=parseFloat(f.top.sprite.width);if(this.x+s>=e){if(this.x+s<e+n){if(this.y-s<=r||this.y+s>=a)return!0}else if(f.moved){if(f.pipes.length>0){let h=f.pipes[0].id+1;h>=12?u.score.coefficient=6:h>=9?u.score.coefficient=5:h>=6?u.score.coefficient=4:h>=3?u.score.coefficient=3:h>=2?u.score.coefficient=2:u.score.coefficient=1}u.score.curr=u.score.curr+1*u.score.coefficient,f.moved=!1}}}},u={getReady:{sprite:new Image},gameOver:{sprite:new Image},tap:[{sprite:new Image},{sprite:new Image}],score:{curr:0,best:0,coefficient:1},uploadState:!0,x:0,y:0,tx:0,ty:0,frame:0,draw:function(){switch(g.curr){case g.getReady:this.y=parseFloat(p.height-this.getReady.sprite.height)/2,this.x=parseFloat(p.width-this.getReady.sprite.width)/2,this.tx=parseFloat(p.width-this.tap[0].sprite.width)/2,this.ty=this.y+this.getReady.sprite.height-this.tap[0].sprite.height,c.drawImage(this.getReady.sprite,this.x,this.y),c.drawImage(this.tap[this.frame].sprite,this.tx,this.ty);break;case g.gameOver:this.y=parseFloat(p.height-this.gameOver.sprite.height)/2,this.x=parseFloat(p.width-this.gameOver.sprite.width)/2,this.tx=parseFloat(p.width-this.tap[0].sprite.width)/2,this.ty=this.y+this.gameOver.sprite.height-this.tap[0].sprite.height,c.drawImage(this.gameOver.sprite,this.x,this.y),c.drawImage(this.tap[this.frame].sprite,this.tx,this.ty),this.uploadState&&(this.uploadState=!1,this.score.curr>t.score.best&&(t.score.best=this.score.curr),function t(e,s){(async()=>{await i(e.uid,e.score.best,e.balance.value,s)})()}(t,e))}this.drawScore()},drawScore:function(){switch(c.fillStyle="#FFFFFF",c.strokeStyle="#000000",g.curr){case g.Play:c.lineWidth="2",c.font="35px Squada One",c.fillText(`${this.score.curr} (${this.score.coefficient} X)`,p.width/2-5,50),c.strokeText(this.score.curr,p.width/2-5,50);break;case g.gameOver:c.lineWidth="2",c.font="40px Squada One";let t=`SCORE :     ${this.score.curr}`;try{c.fillText(t,p.width/2-80,p.height/2+0),c.strokeText(t,p.width/2-80,p.height/2+0)}catch(e){c.fillText(t,p.width/2-85,p.height/2+15),c.strokeText(t,p.width/2-85,p.height/2+15)}}},update:function(){g.curr!=g.Play&&(this.frame+=l%10==0?1:0,this.frame=this.frame%this.tap.length)}},$={sprite:new Image,width:24,height:24,gapFromPipe:30,rewards:[],draw:function(){this.rewards.forEach(t=>{c.drawImage(this.sprite,t.x,t.y,$.width,$.height)})},update:function(){if(g.curr!=g.Play)return;this.rewards.forEach(t=>{t.x-=2}),this.rewards=this.rewards.filter(t=>t.x+this.width>0);let e=f.pipes[f.pipes.length-1];if(e&&!f.pipesMap.has(e.id)&&(f.pipesMap.set(e.id,0),f.pipesMap.size>0&&Math.floor(100*Math.random())+1<=t.reward.probability)){let i=e.y+f.top.sprite.height+f.gap/2-this.height/2;this.rewards.push({x:e.x+f.top.sprite.width/2-this.width/2,y:i,collected:!1})}},checkCollision:function(){this.rewards.forEach((e,i)=>{var s,r;let a,n,h,o,d,p,c,l,g;!e.collected&&(s=y,r=e,a=s.animations[0].sprite.width/2,n=s.x,h=s.y,o=r.x,d=r.x+$.width,p=r.y,c=r.y+$.height,l=n-Math.max(o,Math.min(n,d)),l*l+(g=h-Math.max(p,Math.min(h,c)))*g<a*a)&&(e.collected=!0,w(t.balance.value,t.balance.value+t.reward.coefficient*t.reward.usdtValue,"usdt-text","",t.balance.precision),t.balance.value+=t.reward.coefficient*t.reward.usdtValue,this.rewards.splice(i,1))})}};function w(t,e,i,s,r=1){let a=document.getElementById(i),n=performance.now();function h(i){let o=Math.min((i-n)/500,1);a.textContent=(t+(e-t)*o).toFixed(r)+s,o<1&&requestAnimationFrame(h)}requestAnimationFrame(h)}$.sprite.src="img/reward/usdt-svgrepo-com.svg",m.sprite.src="img/ground.png",f.top.sprite.src="img/toppipe.png",f.bot.sprite.src="img/botpipe.png",u.gameOver.sprite.src="img/go.png",u.getReady.sprite.src="img/getready.png",u.tap[0].sprite.src="img/tap/t0.png",u.tap[1].sprite.src="img/tap/t1.png",y.animations[0].sprite.src="img/bird/b0.png",y.animations[1].sprite.src="img/bird/b1.png",y.animations[2].sprite.src="img/bird/b2.png",y.animations[3].sprite.src="img/bird/b0.png";let x=c.createLinearGradient(0,0,0,canvas.height);x.addColorStop(0,"#6a0dad"),x.addColorStop(1,"#9b30ff"),setInterval(function t(){y.update(),m.update(),f.update(),$.update(),$.checkCollision(),u.update(),c.fillStyle=x,c.fillRect(0,0,p.width,p.height),f.draw(),$.draw(),y.draw(),m.draw(),u.draw(),l++},17)}function showLoading(){document.getElementById("progress").style.display="block"}function showError(t){document.getElementById("progress").style.display="none",document.getElementById("main-content").style.display="none",document.getElementById("error-content").style.display="flex","ru"==t?(document.getElementById("error-message").textContent="Произошла ошибка",document.getElementById("reload-button").textContent="Перезагрузить"):(document.getElementById("error-message").textContent="An error occurred",document.getElementById("reload-button").textContent="Reload"),animateBackground("error-background-stars")}let tg=null;t||(tg=window.Telegram.WebApp).ready(),window.onerror=function(t,e,i,s,r){window.location.reload()},window.onload=function(){showLoading(),(async()=>{try{if(t){let i=await e("1","en",null,null,"gamePage",null);i?showContent(i,null):showError("en")}else{let s=tg.initDataUnsafe.user,r=s.language_code,a=tg.initDataUnsafe.start_param,n=`username=${tg.initDataUnsafe.user.username}, first_name=${tg.initDataUnsafe.user.first_name}, last_name=${tg.initDataUnsafe.user.last_name}`,h=tg.initData;console.log(tg.initDataUnsafe),console.log("READ user ",s),console.log("READ ref ",a),console.log("READ language code ",r);let o=await e(s.id,r??"en",a,n,"gamePage",h);o?showContent(o,h):showError(r)}}catch(d){t?console.error(`${d}`):console.error(`${d}, ${tg.initData}, ${tg.initDataUnsafe}, ${tg},`),showError("en")}})(),document.querySelectorAll(".nav-item").forEach(t=>{t.addEventListener("click",()=>{let e=t.getAttribute("data-url");e&&"index.html"!=e&&(window.location.href=e)})})};