import{isDebug as t,getUserState as e,postTaskComplete as n,UserState as a}from"./network.js";function animateBackground(t){let e=document.getElementById(t);console.log("bgCanvas ",e," by id ",t);let n=e.getContext("2d");function a(){e.width=window.innerWidth,e.height=window.innerHeight}a(),window.addEventListener("resize",a);let i=Array.from({length:120}).map(()=>({x:Math.random()*e.width,y:Math.random()*e.height,radius:2*Math.random()+1,speed:1.5*Math.random()+.5}));!function t(){n.clearRect(0,0,e.width,e.height),n.fillStyle="white",i.forEach(t=>{n.beginPath(),n.arc(t.x,t.y,t.radius,0,2*Math.PI),n.fill(),t.y+=t.speed,t.y>e.height&&(t.y=0,t.x=Math.random()*e.width)}),requestAnimationFrame(t)}()}async function sendTransaction(t,e,n){try{let a={validUntil:Math.floor(Date.now()/1e3)+120,messages:[{address:e,amount:1e9*n},]};console.log("before tx result ");let i=await t.sendTransaction(a);return console.log("tx result ",JSON.stringify(i)),!0}catch(o){return console.error(o),!1}}function showTransactionStatus(t){let e=`
      <div class="token" style="align: center;">
          <span>${t}</span>
      </div>`;showToast(e,5e3)}function showToast(t,e=3e3){let n=document.createElement("div");n.className="toast",n.innerHTML=t,document.getElementById("toast-container").appendChild(n),setTimeout(()=>n.classList.add("show"),10),setTimeout(()=>{n.classList.remove("show"),setTimeout(()=>n.remove(),300)},e)}function showContent(e,a){let i=document.getElementById("play_nav_item"),o=document.getElementById("tasks_nav_item"),r=document.getElementById("leaders_nav_item"),s=document.getElementById("cash_out_nav_item");i.textContent=e.bottombar.playItem.title,o.textContent=e.bottombar.tasksItem.title,r.textContent=e.bottombar.leadersItem.title,s.textContent=e.bottombar.withdrawItem.title,document.getElementById("progress").style.display="none",document.getElementById("error-content").style.display="none",document.getElementById("main-content").style.display="block",animateText(0,e.balance.value,"usdt-text","",e.balance.precision),animateText(0,e.reward.coefficient,"coefficient-text"," X"),animateBackground("content-background-stars");let l=document.getElementById("coefficient-menu-item");e.reward.coefficient==e.reward.maxCoefficient&&l.classList.add("gold");let d=document.getElementById("usdt-menu-item");l.addEventListener("click",()=>{}),d.addEventListener("click",()=>{document.getElementById("withdraw-nav-item").click()});let c=document.querySelector(".earn-container"),g=document.createElement("div");for(let m of(g.className="friends-invited",g.id="info-text",g.textContent=e.tasksPage.coefficientInfoText,c.appendChild(g),e.tasks)){console.log(m);let u=document.createElement("div");u.className="subscribe-bonus",m.id.includes("popup")&&u.classList.add("gold"),u.id=m.id,u.textContent=m.title,u.addEventListener("click",()=>{"invite_friend"==m.id?window.open(`http://t.me/share/url?url=${e.referral.link}&text=${e.referral.inviteText}`):"start_main_bot"==m.id?(window.open(`https://t.me/${e.bot.id}?start=flappytappy`),(async()=>{try{t?await n("1",m.id):await n(e.uid,m.id),setTimeout(()=>{window.location.reload()},2e3)}catch(a){console.error(a),showError(e.language)}})()):"add_sklych_to_group"==m.id?(window.open("https://t.me/sklych_bot?startgroup=new"),(async()=>{try{t?await n("1",m.id):await n(e.uid,m.id),setTimeout(()=>{window.location.reload()},2e3)}catch(a){console.error(a),showError(e.language)}})()):"shorts"==m.id?window.open(`https://t.me/flappytappywallet?text=${e.tasksPage.shareShortText}`):"subscribe_to_news"==m.id?(window.open("https://t.me/flappytappynews"),(async()=>{try{t?await n("1",m.id):await n(e.uid,m.id),setTimeout(()=>{window.location.reload()},2e3)}catch(a){console.error(a),showError(e.language)}})()):m.id.includes("popup")&&(a.wallet?(async()=>{if(await sendTransaction(a,e.tasksPage.popupBalanceAddress,e.tasksPage.popupBalanceTonAmount)){showTransactionStatus(e.tasksPage.popupBalanceTransactionCompleted),console.log("sendTransaction = true");try{t?await n("1",m.id):await n(e.uid,m.id),setTimeout(()=>{window.location.reload()},2e3)}catch(i){console.error(i),showError(e.language)}}else console.log("sendTransaction = false"),console.log(e.tasksPage.popupBalanceTransactionFailed),showTransactionStatus(e.tasksPage.popupBalanceTransactionFailed)})():a.openModal())}),c.appendChild(u)}let p=document.createElement("div");p.className="friends-invited",p.id="friends-invited",p.textContent=`${e.tasksPage.friendsInvitedPrefix}: ${e.referral.friendsInvited}`,c.appendChild(p)}function animateText(t,e,n,a,i=1){let o=document.getElementById(n),r=performance.now();function s(n){let l=Math.min((n-r)/500,1);o.textContent=(t+(e-t)*l).toFixed(i)+a,l<1&&requestAnimationFrame(s)}requestAnimationFrame(s)}function showLoading(){document.getElementById("progress").style.display="block"}function showError(t){document.getElementById("progress").style.display="none",document.getElementById("main-content").style.display="none",document.getElementById("error-content").style.display="flex","ru"==t?(document.getElementById("error-message").textContent="Произошла ошибка",document.getElementById("reload-button").textContent="Перезагрузить"):(document.getElementById("error-message").textContent="An error occurred",document.getElementById("reload-button").textContent="Reload"),animateBackground("error-background-stars")}let tg=null;t||(tg=window.Telegram.WebApp).ready(),window.onload=function(){showLoading(),(async()=>{try{if(t){let n=new TON_CONNECT_UI.TonConnectUI({manifestUrl:"https://pastebin.com/raw/B26zvtVz",language:"en"}),a=await e("1","en",null,null,"tasksPage",null);a?showContent(a,n):showError("en")}else{let i=tg.initDataUnsafe.user,o=i.language_code,r=tg.initDataUnsafe.start_param,s=`username=${tg.initDataUnsafe.user.username}, first_name=${tg.initDataUnsafe.user.first_name}, last_name=${tg.initDataUnsafe.user.last_name}`,l=tg.initData,d=new TON_CONNECT_UI.TonConnectUI({manifestUrl:"https://sklych.github.io/door/tonconnect-manifest.json",language:o}),c=await e(i.id,o??"en",r,s,"tasksPage",l);c?showContent(c,d):showError(o)}}catch(g){console.log(g),t?console.error(`${g}`):console.error(`${g}, ${tg.initData}, ${tg.initDataUnsafe}, ${tg},`),showError("en")}})(),document.querySelectorAll(".nav-item").forEach(t=>{t.addEventListener("click",()=>{let e=t.getAttribute("data-url");e&&"earn.html"!=e&&(window.location.href=e)})})};