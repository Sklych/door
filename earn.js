import{isDebug as e,getUserState as t,postTaskComplete as a,getactivatexinvoice as n,UserState as i}from"./network.js";function animateBackground(e){let t=document.getElementById(e);console.log("bgCanvas ",t," by id ",e);let a=t.getContext("2d");function n(){t.width=window.innerWidth,t.height=window.innerHeight}n(),window.addEventListener("resize",n);let i=Array.from({length:120}).map(()=>({x:Math.random()*t.width,y:Math.random()*t.height,radius:2*Math.random()+1,speed:1.5*Math.random()+.5}));!function e(){a.clearRect(0,0,t.width,t.height),a.fillStyle="white",i.forEach(e=>{a.beginPath(),a.arc(e.x,e.y,e.radius,0,2*Math.PI),a.fill(),e.y+=e.speed,e.y>t.height&&(e.y=0,e.x=Math.random()*t.width)}),requestAnimationFrame(e)}()}async function sendTransaction(e,t,a){try{let n={validUntil:Math.floor(Date.now()/1e3)+120,messages:[{address:t,amount:1e9*a},]};console.log("before tx result ");let i=await e.sendTransaction(n);return console.log("tx result ",JSON.stringify(i)),!0}catch(o){return console.error(o),!1}}function showTransactionStatus(e){let t=`
      <div class="token" style="align: center;">
          <span>${e}</span>
      </div>`;showToast(t,5e3)}function showToast(e,t=3e3){let a=document.createElement("div");a.className="toast",a.innerHTML=e,document.getElementById("toast-container").appendChild(a),setTimeout(()=>a.classList.add("show"),10),setTimeout(()=>{a.classList.remove("show"),setTimeout(()=>a.remove(),300)},t)}function showContent(t,i,o){let r=document.getElementById("play_nav_item"),s=document.getElementById("tasks_nav_item"),l=document.getElementById("leaders_nav_item"),d=document.getElementById("cash_out_nav_item");r.textContent=t.bottombar.playItem.title,s.textContent=t.bottombar.tasksItem.title,l.textContent=t.bottombar.leadersItem.title,d.textContent=t.bottombar.withdrawItem.title,document.getElementById("progress").style.display="none",document.getElementById("error-content").style.display="none",document.getElementById("main-content").style.display="block",animateText(0,t.balance.value,"usdt-text","",t.balance.precision),animateText(0,t.reward.coefficient,"coefficient-text"," X"),animateBackground("content-background-stars");let c=document.getElementById("coefficient-menu-item");t.reward.coefficient>=t.reward.maxCoefficient&&c.classList.add("gold");let g=document.getElementById("usdt-menu-item");c.addEventListener("click",()=>{}),g.addEventListener("click",()=>{document.getElementById("withdraw-nav-item").click()});let p=document.querySelector(".earn-container"),m=document.createElement("div");for(let u of(m.className="friends-invited",m.id="info-text",m.textContent=t.tasksPage.coefficientInfoText,p.appendChild(m),t.tasks)){console.log(u);let y=document.createElement("div");y.className="subscribe-bonus",u.id.includes("popup")&&y.classList.add("gold"),y.id=u.id,y.textContent=u.title,y.addEventListener("click",()=>{"invite_friend"==u.id?window.open(`http://t.me/share/url?url=${t.referral.link}&text=${t.referral.inviteText}`):"start_main_bot"==u.id?(window.open(`https://t.me/${t.bot.id}?start=flappytappy`),(async()=>{try{e?await a("1",u.id,o):await a(t.uid,u.id,o),setTimeout(()=>{window.location.reload()},2e3)}catch(n){console.error(n),showError(t.language)}})()):"add_sklych_to_group"==u.id?(window.open("https://t.me/sklych_bot?startgroup=new"),(async()=>{try{e?await a("1",u.id,o):await a(t.uid,u.id,o),setTimeout(()=>{window.location.reload()},2e3)}catch(n){console.error(n),showError(t.language)}})()):"shorts"==u.id?window.open(`https://t.me/flappytappywallet?text=${t.tasksPage.shareShortText}`):"subscribe_to_news"==u.id?(window.open("https://t.me/flappytappynews"),(async()=>{try{e?await a("1",u.id,o):await a(t.uid,u.id,o),setTimeout(()=>{window.location.reload()},2e3)}catch(n){console.error(n),showError(t.language)}})()):u.id.includes("starspopup")?(async()=>{console.log("click starspopup");try{console.log("click inside async");let i=(await n(t.uid,t.language,o)).result;console.log("invoice link url ",i),window.Telegram.WebApp.openInvoice(i,n=>{"cancelled"===n||"failed"===n?window.Telegram.WebApp.showAlert(t.tasksPage.popupBalanceTransactionFailed):(showTransactionStatus(t.tasksPage.popupBalanceTransactionCompleted),e?a("1",u.id,o):a(t.uid,u.id,o),setTimeout(()=>{window.location.reload()},2e3))})}catch(r){console.error(r)}})():u.id.includes("popup")&&(i.wallet?(async()=>{if(await sendTransaction(i,t.tasksPage.popupBalanceAddress,t.tasksPage.popupBalanceTonAmount)){showTransactionStatus(t.tasksPage.popupBalanceTransactionCompleted),console.log("sendTransaction = true");try{e?await a("1",u.id,o):await a(t.uid,u.id,o),setTimeout(()=>{window.location.reload()},2e3)}catch(n){console.error(n),showError(t.language)}}else console.log("sendTransaction = false"),console.log(t.tasksPage.popupBalanceTransactionFailed),showTransactionStatus(t.tasksPage.popupBalanceTransactionFailed)})():i.openModal())}),p.appendChild(y)}let h=document.createElement("div");h.className="friends-invited",h.id="friends-invited",h.textContent=`${t.tasksPage.friendsInvitedPrefix}: ${t.referral.friendsInvited}`,p.appendChild(h)}function animateText(e,t,a,n,i=1){let o=document.getElementById(a),r=performance.now();function s(a){let l=Math.min((a-r)/500,1);o.textContent=(e+(t-e)*l).toFixed(i)+n,l<1&&requestAnimationFrame(s)}requestAnimationFrame(s)}function showLoading(){document.getElementById("progress").style.display="block"}function showError(e){document.getElementById("progress").style.display="none",document.getElementById("main-content").style.display="none",document.getElementById("error-content").style.display="flex","ru"==e?(document.getElementById("error-message").textContent="Произошла ошибка",document.getElementById("reload-button").textContent="Перезагрузить"):(document.getElementById("error-message").textContent="An error occurred",document.getElementById("reload-button").textContent="Reload"),animateBackground("error-background-stars")}let tg=null;e||(tg=window.Telegram.WebApp).ready(),window.onload=function(){showLoading(),(async()=>{try{if(e){let a=new TON_CONNECT_UI.TonConnectUI({manifestUrl:"https://pastebin.com/raw/B26zvtVz",language:"en"}),n=await t("1","en",null,null,"tasksPage",null);n?showContent(n,a,null):showError("en")}else{let i=tg.initDataUnsafe.user,o=i.language_code,r=tg.initDataUnsafe.start_param,s=`username=${tg.initDataUnsafe.user.username}, first_name=${tg.initDataUnsafe.user.first_name}, last_name=${tg.initDataUnsafe.user.last_name}`,l=tg.initData,d=new TON_CONNECT_UI.TonConnectUI({manifestUrl:"https://sklych.github.io/door/tonconnect-manifest.json",language:o}),c=await t(i.id,o??"en",r,s,"tasksPage",l);c?showContent(c,d,l):showError(o)}}catch(g){console.log(g),e?console.error(`${g}`):console.error(`${g}, ${tg.initData}, ${tg.initDataUnsafe}, ${tg},`),showError("en")}})(),document.querySelectorAll(".nav-item").forEach(e=>{e.addEventListener("click",()=>{let t=e.getAttribute("data-url");t&&"earn.html"!=t&&(window.location.href=t)})})};